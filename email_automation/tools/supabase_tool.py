from typing import Dict, Any, List, Optional
from supabase import create_client, Client
from crewai_tools import BaseTool
from config.settings import settings
from utils.logger import logger
from utils.security import SecurityManager

class SupabaseTool(BaseTool):
    name: str = "Supabase Tool"
        description: str = "Manages data in Supabase database"
            
                def __init__(self):
                        super().__init__()
                                self.client: Client = create_client(
                                            supabase_url=settings.supabase_url,
                                                        supabase_key=settings.supabase_key
                                                                )
                                                                    
                                                                        def _run(self, operation: str, **kwargs) -> Dict[str, Any]:
                                                                                """Execute Supabase operations"""
                                                                                        try:
                                                                                                    if operation == "insert_email":
                                                                                                                    return self._insert_email(**kwargs)
                                                                                                                                elif operation == "update_email":
                                                                                                                                                return self._update_email(**kwargs)
                                                                                                                                                            elif operation == "get_unsent_emails":
                                                                                                                                                                            return self._get_unsent_emails(**kwargs)
                                                                                                                                                                                        elif operation == "search_knowledge":
                                                                                                                                                                                                        return self._search_knowledge(**kwargs)
                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                    raise ValueError(f"Unknown operation: {operation}")
                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                        logger.error("Supabase error", error=str(e))
                                                                                                                                                                                                                                                                    raise KnowledgeBaseError(f"Supabase error: {e}")
                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                            def _insert_email(self, email_data: Dict[str, Any]) -> Dict[str, Any]:
                                                                                                                                                                                                                                                                                    """Insert email record into database"""
                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                        # Sanitize input data
                                                                                                                                                                                                                                                                                                                    sanitized_data = {
                                                                                                                                                                                                                                                                                                                                    k: SecurityManager.sanitize_input(str(v)) if isinstance(v, str) else v
                                                                                                                                                                                                                                                                                                                                                    for k, v in email_data.items()
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                        response = self.client.table('emails').insert(sanitized_data).execute()
                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                if response.data:
                                                                                                                                                                                                                                                                                                                                                                                                                                return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    'success': True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id': response.data[0]['id'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'data': response.data[0]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        raise KnowledgeBaseError("Failed to insert email record")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error("Failed to insert email", error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        raise KnowledgeBaseError(f"Failed to insert email: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def _update_email(self, email_id: str, update_data: Dict[str, Any]) -> Dict[str, Any]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Update email record"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Sanitize update data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sanitized_data = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        k: SecurityManager.sanitize_input(str(v)) if isinstance(v, str) else v
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for k, v in update_data.items()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            response = self.client.table('emails').update(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sanitized_data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ).eq('id', email_id).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if response.data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'success': True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'data': response.data[0]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    raise KnowledgeBaseError("Failed to update email record")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.error("Failed to update email", error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    raise KnowledgeBaseError(f"Failed to update email: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def _get_unsent_emails(self, limit: int = 10) -> List[Dict[str, Any]]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Get unsent emails from database"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = self.client.table('emails').select('*').eq(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'message_sent', False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ).limit(limit).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return response.data if response.data else []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.error("Failed to get unsent emails", error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise KnowledgeBaseError(f"Failed to get unsent emails: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def _search_knowledge(self, query: str, limit: int = 5) -> List[Dict[str, Any]]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Search knowledge base"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # This is a simplified implementation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # In production, you'd use vector search
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = self.client.table('knowledge_base').select('*').ilike(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'content', f'%{query}%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ).limit(limit).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return response.data if response.data else []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.error("Failed to search knowledge base", error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise KnowledgeBaseError(f"Failed to search knowledge base: {e}")