from typing import Dict, Any, List
from crewai import Agent
from tools.gmail_tool import GmailTool
from tools.hubspot_tool import HubSpotTool
from tools.supabase_tool import SupabaseTool
from utils.logger import logger

class EmailProcessorAgent(Agent):
    def __init__(self):
            super().__init__(
                        role='Email Processing Specialist',
                                    goal='Process incoming emails and extract relevant information',
                                                backstory='You specialize in analyzing email content and extracting key information for further processing.',
                                                            tools=[GmailTool(), HubSpotTool(), SupabaseTool()],
                                                                        verbose=True
                                                                                )
                                                                                    
                                                                                        def process_incoming_emails(self, max_emails: int = 10) -> List[Dict[str, Any]]:
                                                                                                """Process incoming emails and extract relevant information"""
                                                                                                        try:
                                                                                                                    logger.info("Starting email processing", max_emails=max_emails)
                                                                                                                                
                                                                                                                                            # Get new emails
                                                                                                                                                        gmail_tool = GmailTool()
                                                                                                                                                                    emails = gmail_tool._run("get_messages", max_results=max_emails)
                                                                                                                                                                                
                                                                                                                                                                                            processed_emails = []
                                                                                                                                                                                                        
                                                                                                                                                                                                                    for email in emails:
                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                        # Extract sender information
                                                                                                                                                                                                                                                                            sender_email = self._extract_email_address(email['from'])
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    # Search for contact in HubSpot
                                                                                                                                                                                                                                                                                                                                        hubspot_tool = HubSpotTool()
                                                                                                                                                                                                                                                                                                                                                            contact = hubspot_tool._run("search_contact", email=sender_email)
                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                    # Get contact notes if exists
                                                                                                                                                                                                                                                                                                                                                                                                                        contact_notes = []
                                                                                                                                                                                                                                                                                                                                                                                                                                            if contact:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    contact_notes = hubspot_tool._run("get_contact_notes", contact_id=contact['id'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Get email thread if exists
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                thread_data = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if email.get('thread_id'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            thread_data = gmail_tool._run("get_thread", thread_id=email['thread_id'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Store processed email
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        processed_email = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id': email['id'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'thread_id': email.get('thread_id'),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'subject': email['subject'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'from': email['from'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'to': email['to'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'body': email['body'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'date': email['date'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'sender_email': sender_email,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'contact': contact,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'contact_notes': contact_notes,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'thread_data': thread_data,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'processed_at': datetime.utcnow().isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    processed_emails.append(processed_email)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Store in database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                supabase_tool = SupabaseTool()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    supabase_tool._run("insert_email", email_data=processed_email)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error("Failed to process email", email_id=email['id'], error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info("Email processing completed", processed_count=len(processed_emails))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return processed_emails
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.error("Failed to process incoming emails", error=str(e))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                raise EmailProcessingError(f"Failed to process incoming emails: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def _extract_email_address(self, from_header: str) -> str:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Extract email address from From header"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import re
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Pattern to match email addresses
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                email_pattern = r'[\w\.-]+@[\w\.-]+\.\w+'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                match = re.search(email_pattern, from_header)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if match:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return match.group(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return from_header.strip()